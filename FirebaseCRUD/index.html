<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Firebase Fetch</title>
	<style>
		.container {
			max-width: 900px;
			font-family: sans-serif;
			margin: auto;
		}
		h1 {
			text-align: center;
			margin-bottom: 30px;
		}
		table {
			width: 100%;
			border-spacing: 0px;
		}
		th {
			text-align: left;
		}
		table td:focus {
			background-color: #eae9e9;
		}
		td:nth-child(3) {
			width: 400px;
		}
		td:last-child {
			text-align: right;
		}
		table th,
		table td {
			padding: 15px 0;
			border-bottom: 1px solid #cacaca;
			outline: none;
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>Realtime fetching from Firebase Database</h1>
		<table>
			<thead>
				<tr>
					<th>Name</th>
					<th>Email</th>
					<th>Message</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>Sample Name</td>
					<td>Sample Email</td>
					<td>Sample Message</td>
					<td>
						<button onclick="">Update</button>
						<button onclick="">Delete</button>
					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<!-- add firebase CDN -->
	<script src="https://www.gstatic.com/firebasejs/9.12.1/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.12.1/firebase-database-compat.js"></script>

	<script>
		const firebaseConfig = {
			databaseURL : "https://baguscrudfirebase-default-rtdb.asia-southeast1.firebasedatabase.app"
		}
		firebase.initializeApp(firebaseConfig);

		// create connection with firebase
		const database = firebase.database();

		const dataContainer = document.querySelector("tbody")

		// give complete path to fetch data as given during sending
		const fetchedData = database.ref("messages/")
		fetchedData.on("value", snapshot => {
			const data = snapshot.val()
			// console.log(data)
			let htmlData = ""
			for (let key in data) {
				let value = data[key]
				console.log(value)
				htmlData += `
					<tr>
					<td>${value.name}</td>
					<td>${value.email}</td>
					<td>${value.message}</td>
					<td>
						<button onclick="readyForUpdate('${key}', this)">Update</button>
						<button onclick="removeMess('${key}')">Delete</button>
					</td>
				</tr>
				`
			}
			dataContainer.innerHTML = htmlData
		})

		// remove message function
		function removeMess(uniqueID) {
			// console.log(uniqueID)
			database.ref('messages/' + uniqueID).remove()
			// this realtime remove will delete data without any loading
			// as data is updated, it refetch and rerender in html automatically
		}

		// update function
		function readyForUpdate(uniqueID, elem) {
			// console.log(uniqueID)
			const siblingTd = elem.parentElement.parentElement.getElementsByTagName("td")
			// convert first three td to be editable
			for(let i = 0; i < siblingTd.length-1; i++) {
				siblingTd[i].contentEditable = true;
				siblingTd[i].classList.add('temp-update-class')
			}
			// also change onclick function
			elem.setAttribute('onclick', `updateNow('${uniqueID}')`)
			elem.innerHTML = 'Send'
		}

		// create update now function
		function updateNow(uniqueID) {
			const contentId = document.querySelectorAll(".temp-update-class")
			// now create obj using same keys as used during sending
			let obj = {
				"name": contentId[0].textContent,
				"email": contentId[1].textContent,
				"message": contentId[2].textContent,
			}
			// create reference to the data first where data will update
			const listRef = database.ref("messages/" + uniqueID)
			// now provide update data
			listRef.update(obj)
			// after update new data will rerender automatically
			// same as during delete
		}
	</script>
</body>
</html>